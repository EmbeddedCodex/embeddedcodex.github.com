<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电网协议串口工具</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2980b9;
        }
        .row {
            display: flex;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .col {
            flex: 1;
            min-width: 200px;
            margin-right: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        select, input, button {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .btn-danger {
            background-color: #e74c3c;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn-success {
            background-color: #2ecc71;
        }
        .btn-success:hover {
            background-color: #27ae60;
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: monospace;
        }
        .hex-textarea {
            font-family: monospace;
            font-size: 14px;
        }
        .protocol-section {
            background-color: #e8f4fc;
            border-left-color: #2980b9;
        }
        .data-section {
            background-color: #f0f8e8;
            border-left-color: #2ecc71;
        }
        .log-section {
            background-color: #fef5e7;
            border-left-color: #f39c12;
        }
        .status-bar {
            margin-top: 20px;
            padding: 10px;
            background-color: #34495e;
            color: white;
            border-radius: 4px;
            font-family: monospace;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
        }
        .tab-button {
            padding: 10px 20px;
            background-color: #f1f1f1;
            border: none;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab-button.active {
            background-color: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 15px;
            border: 1px solid #ddd;
            border-top: none;
            background-color: white;
        }
        .tab-content.active {
            display: block;
        }
        .data-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #fff;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        .data-item-header {
            font-weight: bold;
            margin-bottom: 5px;
            color: #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>电网协议串口数据工具</h1>
        
        <!-- 串口配置部分 -->
        <div class="section">
            <div class="section-title">串口配置</div>
            <div class="row">
                <div class="col">
                    <label for="port-select">串口选择</label>
                    <select id="port-select">
                        <option value="">-- 请选择串口 --</option>
                        <!-- 将通过JavaScript动态填充 -->
                    </select>
                </div>
                <div class="col">
                    <label for="baud-rate">波特率</label>
                    <select id="baud-rate">
                        <option value="1200">1200</option>
                        <option value="2400">2400</option>
                        <option value="4800">4800</option>
                        <option value="9600" selected>9600</option>
                        <option value="19200">19200</option>
                        <option value="38400">38400</option>
                        <option value="57600">57600</option>
                        <option value="115200">115200</option>
                    </select>
                </div>
                <div class="col">
                    <label for="data-bits">数据位</label>
                    <select id="data-bits">
                        <option value="7">7</option>
                        <option value="8" selected>8</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <label for="parity">校验位</label>
                    <select id="parity">
                        <option value="none">无</option>
                        <option value="even">偶校验</option>
                        <option value="odd">奇校验</option>
                    </select>
                </div>
                <div class="col">
                    <label for="stop-bits">停止位</label>
                    <select id="stop-bits">
                        <option value="1">1</option>
                        <option value="2">2</option>
                    </select>
                </div>
                <div class="col">
                    <label>&nbsp;</label>
                    <button id="connect-btn">连接串口</button>
                </div>
            </div>
        </div>
        
        <!-- 协议选择部分 -->
        <div class="section protocol-section">
            <div class="section-title">协议配置</div>
            <div class="row">
                <div class="col">
                    <label for="protocol-select">协议类型</label>
                    <select id="protocol-select">
                        <option value="DL/T645">DL/T645-2007</option>
                        <option value="DL/T645-1997">DL/T645-1997</option>
                        <option value="DL/T698">DL/T698.45</option>
                        <option value="DL/T376.1">DL/T376.1</option>
                        <option value="DL/T376.2">DL/T376.2</option>
                        <option value="custom">自定义</option>
                    </select>
                </div>
                <div class="col">
                    <label for="frame-type">帧类型</label>
                    <select id="frame-type">
                        <option value="read">读数据</option>
                        <option value="write">写数据</option>
                        <option value="broadcast">广播</option>
                        <option value="response">响应</option>
                    </select>
                </div>
                <div class="col">
                    <label for="address">设备地址</label>
                    <input type="text" id="address" placeholder="12位表号或地址">
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <label for="data-identifier">数据标识</label>
                    <input type="text" id="data-identifier" placeholder="如9010F000">
                </div>
                <div class="col">
                    <label for="data-value">数据值</label>
                    <input type="text" id="data-value" placeholder="写入的数据值">
                </div>
                <div class="col">
                    <label>&nbsp;</label>
                    <button id="build-frame-btn" class="btn-success">组包</button>
                </div>
            </div>
        </div>
        
        <!-- 数据收发部分 -->
        <div class="section data-section">
            <div class="section-title">数据收发</div>
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="send">发送数据</button>
                    <button class="tab-button" data-tab="receive">接收数据</button>
                    <button class="tab-button" data-tab="history">历史记录</button>
                </div>
                <div id="send" class="tab-content active">
                    <label for="send-data">发送数据 (HEX格式)</label>
                    <textarea id="send-data" class="hex-textarea" placeholder="输入16进制数据，如68 11 11 11 11 11 11 68 11 04 33 33 33 33 16"></textarea>
                    <div class="row">
                        <div class="col">
                            <button id="send-btn" class="btn-success">发送</button>
                        </div>
                        <div class="col">
                            <button id="clear-send-btn">清空</button>
                        </div>
                        <div class="col">
                            <button id="save-template-btn">保存为模板</button>
                        </div>
                    </div>
                </div>
                <div id="receive" class="tab-content">
                    <label for="receive-data">接收数据 (HEX格式)</label>
                    <textarea id="receive-data" class="hex-textarea" readonly></textarea>
                    <div class="row">
                        <div class="col">
                            <button id="parse-btn">解析数据</button>
                        </div>
                        <div class="col">
                            <button id="clear-receive-btn">清空</button>
                        </div>
                        <div class="col">
                            <button id="save-receive-btn">保存记录</button>
                        </div>
                    </div>
                </div>
                <div id="history" class="tab-content">
                    <div id="history-list">
                        <!-- 历史记录将通过JavaScript动态填充 -->
                        <div class="data-item">
                            <div class="data-item-header">2023-05-15 14:30:25 - DL/T645读数据</div>
                            <div>发送: 68 11 11 11 11 11 11 68 11 04 33 33 33 33 16</div>
                            <div>接收: 68 11 11 11 11 11 11 68 91 08 33 33 33 33 33 33 33 33 16</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <button id="clear-history-btn">清空历史</button>
                        </div>
                        <div class="col">
                            <button id="export-history-btn">导出历史</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 数据解析结果 -->
        <div class="section">
            <div class="section-title">数据解析结果</div>
            <div id="parse-result">
                <div class="data-item">
                    <div class="data-item-header">帧头</div>
                    <div>68 - 起始符</div>
                </div>
                <div class="data-item">
                    <div class="data-item-header">地址域</div>
                    <div>11 11 11 11 11 11 - 表号: 111111111111</div>
                </div>
                <div class="data-item">
                    <div class="data-item-header">控制码</div>
                    <div>91 - 读数据应答</div>
                </div>
                <div class="data-item">
                    <div class="data-item-header">数据域长度</div>
                    <div>08 - 8字节</div>
                </div>
                <div class="data-item">
                    <div class="data-item-header">数据域</div>
                    <div>33 33 33 33 33 33 33 33 - 数据标识: 9010F000, 值: 1234.56 kWh</div>
                </div>
                <div class="data-item">
                    <div class="data-item-header">校验和</div>
                    <div>XX - 校验正确</div>
                </div>
                <div class="data-item">
                    <div class="data-item-header">帧尾</div>
                    <div>16 - 结束符</div>
                </div>
            </div>
        </div>
        
        <!-- 状态栏 -->
        <div class="status-bar" id="status-bar">
            就绪
        </div>
    </div>

    <script>
        // 这里将实现所有功能逻辑
        document.addEventListener('DOMContentLoaded', function() {
            // 模拟串口列表
            const portSelect = document.getElementById('port-select');
            const ports = ['COM1', 'COM2', 'COM3', 'COM4', '/dev/ttyUSB0', '/dev/ttyS0'];
            
            ports.forEach(port => {
                const option = document.createElement('option');
                option.value = port;
                option.textContent = port;
                portSelect.appendChild(option);
            });
            
            // 标签切换功能
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    button.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // 连接串口按钮
            document.getElementById('connect-btn').addEventListener('click', function() {
                const port = portSelect.value;
                const baudRate = document.getElementById('baud-rate').value;
                
                if (!port) {
                    updateStatus('请选择串口');
                    return;
                }
                
                updateStatus(`正在连接 ${port} @ ${baudRate}bps...`);
                
                // 模拟连接过程
                setTimeout(() => {
                    updateStatus(`已连接 ${port} @ ${baudRate}bps`);
                    this.textContent = '断开连接';
                    this.classList.add('btn-danger');
                    
                    // 更改点击事件为断开连接
                    this.onclick = function() {
                        updateStatus(`已断开 ${port}`);
                        this.textContent = '连接串口';
                        this.classList.remove('btn-danger');
                        this.onclick = arguments.callee; // 恢复原来的函数
                    };
                }, 1000);
            });
            
            // 组包按钮
            document.getElementById('build-frame-btn').addEventListener('click', function() {
                const protocol = document.getElementById('protocol-select').value;
                const frameType = document.getElementById('frame-type').value;
                const address = document.getElementById('address').value;
                const dataId = document.getElementById('data-identifier').value;
                const dataValue = document.getElementById('data-value').value;
                
                if (!address) {
                    updateStatus('请输入设备地址');
                    return;
                }
                
                let frame = '';
                
                // 模拟不同协议的组包
                if (protocol.includes('645')) {
                    // DL/T645协议组包
                    frame = build645Frame(address, frameType, dataId, dataValue);
                } else if (protocol.includes('698')) {
                    // DL/T698协议组包
                    frame = build698Frame(address, frameType, dataId, dataValue);
                } else if (protocol.includes('376')) {
                    // DL/T376协议组包
                    frame = build376Frame(address, frameType, dataId, dataValue);
                } else {
                    frame = '自定义协议组包功能待实现';
                }
                
                document.getElementById('send-data').value = frame;
                updateStatus(`已生成 ${protocol} ${frameType} 帧`);
            });
            
            // 发送按钮
            document.getElementById('send-btn').addEventListener('click', function() {
                const data = document.getElementById('send-data').value.trim();
                
                if (!data) {
                    updateStatus('请输入要发送的数据');
                    return;
                }
                
                updateStatus(`发送: ${data}`);
                
                // 模拟接收数据
                setTimeout(() => {
                    // 根据协议生成模拟响应
                    const protocol = document.getElementById('protocol-select').value;
                    let response = '';
                    
                    if (protocol.includes('645')) {
                        response = simulate645Response(data);
                    } else if (protocol.includes('698')) {
                        response = simulate698Response(data);
                    } else if (protocol.includes('376')) {
                        response = simulate376Response(data);
                    } else {
                        response = '00 01 02 03 04 05 06 07 08 09 0A';
                    }
                    
                    document.getElementById('receive-data').value = response;
                    updateStatus(`收到响应: ${response}`);
                    
                    // 添加到历史记录
                    addToHistory(data, response, protocol);
                }, 500);
            });
            
            // 解析按钮
            document.getElementById('parse-btn').addEventListener('click', function() {
                const data = document.getElementById('receive-data').value.trim();
                const protocol = document.getElementById('protocol-select').value;
                
                if (!data) {
                    updateStatus('没有可解析的数据');
                    return;
                }
                
                updateStatus(`正在解析 ${protocol} 数据...`);
                
                // 模拟解析过程
                setTimeout(() => {
                    updateStatus(`已解析 ${protocol} 数据`);
                    // 实际应用中这里会调用解析函数并显示结果
                }, 300);
            });
            
            // 清空按钮
            document.getElementById('clear-send-btn').addEventListener('click', function() {
                document.getElementById('send-data').value = '';
            });
            
            document.getElementById('clear-receive-btn').addEventListener('click', function() {
                document.getElementById('receive-data').value = '';
            });
            
            document.getElementById('clear-history-btn').addEventListener('click', function() {
                document.getElementById('history-list').innerHTML = '<p>历史记录已清空</p>';
            });
            
            // 更新状态栏
            function updateStatus(message) {
                document.getElementById('status-bar').textContent = message;
            }
            
            // 添加到历史记录
            function addToHistory(sendData, receiveData, protocol) {
                const historyList = document.getElementById('history-list');
                const now = new Date();
                const timestamp = now.toLocaleString();
                
                const item = document.createElement('div');
                item.className = 'data-item';
                
                item.innerHTML = `
                    <div class="data-item-header">${timestamp} - ${protocol}</div>
                    <div>发送: ${sendData}</div>
                    <div>接收: ${receiveData}</div>
                `;
                
                historyList.insertBefore(item, historyList.firstChild);
            }
            
            // 以下是模拟协议组包和解析的函数
            function build645Frame(address, frameType, dataId, dataValue) {
                // 简化的DL/T645组包逻辑
                let frame = '68 ';
                
                // 地址域 (6字节)
                const addr = address.padStart(12, '0'); // 12位表号
                for (let i = 0; i < 6; i++) {
                    frame += addr.substr(i*2, 2) + ' ';
                }
                
                frame += '68 ';
                
                // 控制码
                if (frameType === 'read') {
                    frame += '11 ';
                } else if (frameType === 'write') {
                    frame += '14 ';
                } else if (frameType === 'broadcast') {
                    frame += '08 ';
                }
                
                // 数据长度 (根据数据标识)
                frame += '04 '; // 假设固定4字节
                
                // 数据标识 (如9010F000 -> 90 10 F0 00)
                if (dataId && dataId.length >= 8) {
                    for (let i = 0; i < 4; i++) {
                        frame += dataId.substr(i*2, 2) + ' ';
                    }
                } else {
                    frame += '33 33 33 33 '; // 默认数据
                }
                
                // 校验和 (简化为固定值)
                frame += 'XX ';
                
                // 结束符
                frame += '16';
                
                return frame;
            }
            
            function build698Frame(address, frameType, dataId, dataValue) {
                // 简化的DL/T698组包逻辑
                let frame = '68 ';
                
                // 长度 (暂时留空)
                frame += 'XX XX XX XX ';
                
                // 控制域
                frame += 'C0 ';
                
                // 地址域
                frame += '01 '; // 地址类型
                frame += '04 '; // 地址长度
                frame += address.substr(0, 8).match(/.{2}/g).join(' ') + ' ';
                
                // 帧序列
                frame += '00 ';
                
                // 服务标识
                if (frameType === 'read') {
                    frame += '01 ';
                } else if (frameType === 'write') {
                    frame += '04 ';
                }
                
                // 数据
                if (dataId) {
                    frame += dataId.match(/.{2}/g).join(' ') + ' ';
                }
                
                if (dataValue) {
                    frame += dataValue.match(/.{2}/g).join(' ') + ' ';
                }
                
                // 结束符
                frame += '16';
                
                return frame;
            }
            
            function build376Frame(address, frameType, dataId, dataValue) {
                // 简化的DL/T376组包逻辑
                let frame = '68 ';
                
                // 地址域
                frame += address.substr(0, 12).match(/.{2}/g).join(' ') + ' ';
                frame += '68 ';
                
                // 控制码
                if (frameType === 'read') {
                    frame += '01 ';
                } else if (frameType === 'write') {
                    frame += '04 ';
                }
                
                // 数据长度
                frame += 'XX ';
                
                // 数据标识
                if (dataId) {
                    frame += dataId.match(/.{2}/g).join(' ') + ' ';
                }
                
                // 数据值
                if (dataValue) {
                    frame += dataValue.match(/.{2}/g).join(' ') + ' ';
                }
                
                // 校验和
                frame += 'XX ';
                
                // 结束符
                frame += '16';
                
                return frame;
            }
            
            function simulate645Response(request) {
                // 简化的DL/T645响应模拟
                if (request.includes('11 04')) { // 读数据
                    return '68 11 11 11 11 11 11 68 91 08 33 33 33 33 33 33 33 33 16';
                } else if (request.includes('14 04')) { // 写数据
                    return '68 11 11 11 11 11 11 68 94 00 16';
                }
                return '68 11 11 11 11 11 11 68 91 08 90 10 F0 00 12 34 56 78 16';
            }
            
            function simulate698Response(request) {
                // 简化的DL/T698响应模拟
                return '68 0B 00 00 00 80 01 04 11 11 11 11 00 01 08 90 10 F0 00 12 34 56 78 16';
            }
            
            function simulate376Response(request) {
                // 简化的DL/T376响应模拟
                return '68 11 11 11 11 11 11 68 81 08 90 10 F0 00 12 34 56 78 XX 16';
            }
        });
    </script>
</body>
</html>