<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电网协议解析工具</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <h1>电网协议解析工具</h1>

        <!-- 协议选择部分 -->
        <div class="section data-section">
            <div class="section-title">协议选择</div>
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="protocol-3762">376.2</button>
                    <button class="tab-button" data-tab="protocol-645">645</button>
                    <button class="tab-button" data-tab="protocol-698">698</button>
                </div>
                <div id="protocol-3762" class="tab-content active">
                    <label for="send-data">HEX格式</label>
                    <textarea id="send-data" class="hex-textarea"
                        placeholder="输入16进制数据，如 68 2E 00 60 01 00 00 00 00 00 20 01 00 00 00 00 02 16 01 02 02 E8 02 00 83 08 07 10 68 20 01 00 00 00 00 68 11 04 33 33 33 33 D2 16 E5 16"></textarea>
                    <div class="row">
                        <div class="col">
                            <button id="send-btn" class="btn-success">解析数据</button>
                        </div>
                        <div class="col">
                            <button id="clear-send-btn">清空</button>
                        </div>
                        <div class="col">
                            <button id="save-template-btn">粘贴</button>
                        </div>
                    </div>
                </div>
                <div id="protocol-645" class="tab-content">
                    <label for="receive-data">HEX格式</label>
                    <textarea id="receive-data" class="hex-textarea" readonly></textarea>
                    <div class="row">
                        <div class="col">
                            <button id="parse-btn">解析数据</button>
                        </div>
                        <div class="col">
                            <button id="clear-receive-btn">清空</button>
                        </div>
                        <div class="col">
                            <button id="save-receive-btn">粘贴</button>
                        </div>
                    </div>
                </div>
                <div id="protocol-698" class="tab-content">
                    <label for="receive-data">HEX格式</label>
                    <div id="history-list">
                        <!-- 历史记录将通过JavaScript动态填充 -->
                        <div class="data-item">
                            <div class="data-item-header">2023-05-15 14:30:25 - DL/T645读数据</div>
                            <div>发送: 68 11 11 11 11 11 11 68 11 04 33 33 33 33 16</div>
                            <div>接收: 68 11 11 11 11 11 11 68 91 08 33 33 33 33 33 33 33 33 16</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <button id="clear-history-btn">清空历史</button>
                        </div>
                        <div class="col">
                            <button id="export-history-btn">导出历史</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据解析结果 -->
        <div class="section">
            <div class="section-title">数据解析结果</div>
            <div id="parse-result">
                <div class="data-item">
                    <div class="data-item-header">帧头</div>
                    <div>68 - 起始符</div>
                </div>
                <div class="data-item">
                    <div class="data-item-header">地址域</div>
                    <div>11 11 11 11 11 11 - 表号: 111111111111</div>
                </div>
                <div class="data-item">
                    <div class="data-item-header">控制码</div>
                    <div>91 - 读数据应答</div>
                </div>
                <div class="data-item">
                    <div class="data-item-header">数据域长度</div>
                    <div>08 - 8字节</div>
                </div>
                <div class="data-item">
                    <div class="data-item-header">数据域</div>
                    <div>33 33 33 33 33 33 33 33 - 数据标识: 9010F000, 值: 1234.56 kWh</div>
                </div>
                <div class="data-item">
                    <div class="data-item-header">校验和</div>
                    <div>XX - 校验正确</div>
                </div>
                <div class="data-item">
                    <div class="data-item-header">帧尾</div>
                    <div>16 - 结束符</div>
                </div>
            </div>
        </div>

        <!-- 状态栏 -->
        <div class="status-bar" id="status-bar">
            就绪
        </div>
    </div>

    <script>
        // 这里将实现所有功能逻辑
        document.addEventListener('DOMContentLoaded', function () {
            // 标签切换功能
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');

                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    button.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });

            // 组包按钮
            document.getElementById('build-frame-btn').addEventListener('click', function () {
                const protocol = document.getElementById('protocol-select').value;
                const frameType = document.getElementById('frame-type').value;
                const address = document.getElementById('address').value;
                const dataId = document.getElementById('data-identifier').value;
                const dataValue = document.getElementById('data-value').value;

                if (!address) {
                    updateStatus('请输入设备地址');
                    return;
                }

                let frame = '';

                // 模拟不同协议的组包
                if (protocol.includes('645')) {
                    // DL/T645协议组包
                    frame = build645Frame(address, frameType, dataId, dataValue);
                } else if (protocol.includes('698')) {
                    // DL/T698协议组包
                    frame = build698Frame(address, frameType, dataId, dataValue);
                } else if (protocol.includes('376')) {
                    // DL/T376协议组包
                    frame = build376Frame(address, frameType, dataId, dataValue);
                } else {
                    frame = '自定义协议组包功能待实现';
                }

                document.getElementById('send-data').value = frame;
                updateStatus(`已生成 ${protocol} ${frameType} 帧`);
            });

            // 发送按钮
            document.getElementById('send-btn').addEventListener('click', function () {
                const data = document.getElementById('send-data').value.trim();

                if (!data) {
                    updateStatus('请输入要发送的数据');
                    return;
                }

                updateStatus(`发送: ${data}`);

                // 模拟接收数据
                setTimeout(() => {
                    // 根据协议生成模拟响应
                    const protocol = document.getElementById('protocol-select').value;
                    let response = '';

                    if (protocol.includes('645')) {
                        response = simulate645Response(data);
                    } else if (protocol.includes('698')) {
                        response = simulate698Response(data);
                    } else if (protocol.includes('376')) {
                        response = simulate376Response(data);
                    } else {
                        response = '00 01 02 03 04 05 06 07 08 09 0A';
                    }

                    document.getElementById('receive-data').value = response;
                    updateStatus(`收到响应: ${response}`);

                    // 添加到历史记录
                    addToHistory(data, response, protocol);
                }, 500);
            });

            // 解析按钮
            document.getElementById('parse-btn').addEventListener('click', function () {
                const data = document.getElementById('receive-data').value.trim();
                const protocol = document.getElementById('protocol-select').value;

                if (!data) {
                    updateStatus('没有可解析的数据');
                    return;
                }

                updateStatus(`正在解析 ${protocol} 数据...`);

                // 模拟解析过程
                setTimeout(() => {
                    updateStatus(`已解析 ${protocol} 数据`);
                    // 实际应用中这里会调用解析函数并显示结果
                }, 300);
            });

            // 清空按钮
            document.getElementById('clear-send-btn').addEventListener('click', function () {
                document.getElementById('send-data').value = '';
            });

            document.getElementById('clear-receive-btn').addEventListener('click', function () {
                document.getElementById('receive-data').value = '';
            });

            document.getElementById('clear-history-btn').addEventListener('click', function () {
                document.getElementById('history-list').innerHTML = '<p>历史记录已清空</p>';
            });

            // 更新状态栏
            function updateStatus(message) {
                document.getElementById('status-bar').textContent = message;
            }

            // 添加到历史记录
            function addToHistory(sendData, receiveData, protocol) {
                const historyList = document.getElementById('history-list');
                const now = new Date();
                const timestamp = now.toLocaleString();

                const item = document.createElement('div');
                item.className = 'data-item';

                item.innerHTML = `
                    <div class="data-item-header">${timestamp} - ${protocol}</div>
                    <div>发送: ${sendData}</div>
                    <div>接收: ${receiveData}</div>
                `;

                historyList.insertBefore(item, historyList.firstChild);
            }

            // 以下是模拟协议组包和解析的函数
            function build645Frame(address, frameType, dataId, dataValue) {
                // 简化的DL/T645组包逻辑
                let frame = '68 ';

                // 地址域 (6字节)
                const addr = address.padStart(12, '0'); // 12位表号
                for (let i = 0; i < 6; i++) {
                    frame += addr.substr(i * 2, 2) + ' ';
                }

                frame += '68 ';

                // 控制码
                if (frameType === 'read') {
                    frame += '11 ';
                } else if (frameType === 'write') {
                    frame += '14 ';
                } else if (frameType === 'broadcast') {
                    frame += '08 ';
                }

                // 数据长度 (根据数据标识)
                frame += '04 '; // 假设固定4字节

                // 数据标识 (如9010F000 -> 90 10 F0 00)
                if (dataId && dataId.length >= 8) {
                    for (let i = 0; i < 4; i++) {
                        frame += dataId.substr(i * 2, 2) + ' ';
                    }
                } else {
                    frame += '33 33 33 33 '; // 默认数据
                }

                // 校验和 (简化为固定值)
                frame += 'XX ';

                // 结束符
                frame += '16';

                return frame;
            }

            function build698Frame(address, frameType, dataId, dataValue) {
                // 简化的DL/T698组包逻辑
                let frame = '68 ';

                // 长度 (暂时留空)
                frame += 'XX XX XX XX ';

                // 控制域
                frame += 'C0 ';

                // 地址域
                frame += '01 '; // 地址类型
                frame += '04 '; // 地址长度
                frame += address.substr(0, 8).match(/.{2}/g).join(' ') + ' ';

                // 帧序列
                frame += '00 ';

                // 服务标识
                if (frameType === 'read') {
                    frame += '01 ';
                } else if (frameType === 'write') {
                    frame += '04 ';
                }

                // 数据
                if (dataId) {
                    frame += dataId.match(/.{2}/g).join(' ') + ' ';
                }

                if (dataValue) {
                    frame += dataValue.match(/.{2}/g).join(' ') + ' ';
                }

                // 结束符
                frame += '16';

                return frame;
            }

            function build376Frame(address, frameType, dataId, dataValue) {
                // 简化的DL/T376组包逻辑
                let frame = '68 ';

                // 地址域
                frame += address.substr(0, 12).match(/.{2}/g).join(' ') + ' ';
                frame += '68 ';

                // 控制码
                if (frameType === 'read') {
                    frame += '01 ';
                } else if (frameType === 'write') {
                    frame += '04 ';
                }

                // 数据长度
                frame += 'XX ';

                // 数据标识
                if (dataId) {
                    frame += dataId.match(/.{2}/g).join(' ') + ' ';
                }

                // 数据值
                if (dataValue) {
                    frame += dataValue.match(/.{2}/g).join(' ') + ' ';
                }

                // 校验和
                frame += 'XX ';

                // 结束符
                frame += '16';

                return frame;
            }

            function simulate645Response(request) {
                // 简化的DL/T645响应模拟
                if (request.includes('11 04')) { // 读数据
                    return '68 11 11 11 11 11 11 68 91 08 33 33 33 33 33 33 33 33 16';
                } else if (request.includes('14 04')) { // 写数据
                    return '68 11 11 11 11 11 11 68 94 00 16';
                }
                return '68 11 11 11 11 11 11 68 91 08 90 10 F0 00 12 34 56 78 16';
            }

            function simulate698Response(request) {
                // 简化的DL/T698响应模拟
                return '68 0B 00 00 00 80 01 04 11 11 11 11 00 01 08 90 10 F0 00 12 34 56 78 16';
            }

            function simulate376Response(request) {
                // 简化的DL/T376响应模拟
                return '68 11 11 11 11 11 11 68 81 08 90 10 F0 00 12 34 56 78 XX 16';
            }
        });
    </script>

    <script src="../../assets/js/utils/parser.js"></script>
    <script src="script.js"></script>
</body>

</html>