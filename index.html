<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Title of the document</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>传输帧格式</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }
    </style>
</head>


<body>

    <h1>3762校验与解析</h1>
    <input type="text" id="hexInput" placeholder="输入十六进制字符串" style="width: 92%;"
        value="68 2E 00 60 01 00 00 00 00 00 20 01 00 00 00 00 02 16 01 02 02 E8 02 00 83 08 07 10 68 20 01 00 00 00 00 68 11 04 33 33 33 33 D2 16 E5 16">
    <button onclick="parseHex()">解析</button>
    <div class="result" id="result"></div>
    <br><br>

    <script>
        function parseHex() {
            const input = document.getElementById('hexInput').value;
            const resultDiv = document.getElementById('result');

            if (!/^[0-9A-Fa-f ]+$/.test(input)) {
                resultDiv.innerHTML = "输入无效，请输入有效的十六进制字符串。";
                return;
            }
            // 68 2E 00 60 01 00 00 00 00 00 20 01 00 00 00 00 02 16 01 02 02 E8 02 00 83 08 07 10 68 20 01 00 00 00 00 68 11 04 33 33 33 33 D2 16 E5 16 

            const bytes = [];
            const hexArray = input.split(' ');
            for (let hex of hexArray) {
                if (hex.length === 2) {
                    const byte = parseInt(hex, 16);
                    bytes.push(byte);
                } else {
                    resultDiv.innerHTML += `无效的十六进制数: ${hex}<br>`;
                    return;
                }
            }

            const frame_len = bytes[1] + bytes[2] * 16;

            let frame_cs = 0;
            for (let i = 3; i < frame_len - 2; i++) {
                frame_cs += bytes[i];
            }
            frame_cs &= 0xFF;

            // 清空之前的内容
            resultDiv.innerHTML = '';

            // 创建一个新的段落元素
            let element = document.createElement('p');

            // 设置段落的文本内容，计算解析结果字符串
            element.textContent = '解析结果: ' + bytes.map(function (num) {
                return num.toString(16).padStart(2, '0').toUpperCase();
            }).join(' ');

            // 将新创建的段落元素添加到文档的 resultDiv 中
            resultDiv.appendChild(element);

            // 起始
            element = document.createElement('p');
            element.textContent = '起始：' + hexArray[0] + 'H';
            resultDiv.appendChild(element);

            // 长度
            element = document.createElement('p');
            element.textContent = '长度：' + frame_len + ', ' + bytes.length;
            resultDiv.appendChild(element);

            if (frame_len != bytes.length) {
                return;
            }

            // 控制域
            const frame_C = bytes[3];
            element = document.createElement('p');
            element.textContent = '控制域：' + frame_C.toString(16).padStart(2, '0').toUpperCase() + 'H';
            resultDiv.appendChild(element);

            // 创建表格元素
            const table = document.createElement('table');

            // 创建表头行
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const headers = ['D7', 'D6', 'D5', 'D4-D3', 'D2-D0'];
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // 创建第二行，用于显示参数名称
            const tbody = document.createElement('tbody');
            const paramRow = document.createElement('tr');
            const params = ['传输方向位 DIR', '启动标志位 PRM', '地址域标识 ADD', '协议版本号 VER', '保留'];
            params.forEach(paramText => {
                const td = document.createElement('td');
                td.textContent = paramText;
                paramRow.appendChild(td);
            });
            tbody.appendChild(paramRow);

            // 创建第三行，用于解析参数
            const explanationRow = document.createElement('tr');
            let explanations = [];
            if (frame_C & 0x80) {
                explanations.push('上行方向')
            } else {
                explanations.push('下行方向')
            }
            if (frame_C & 0x40) {
                explanations.push('来自启动站')
            } else {
                explanations.push('来自从动站')
            }
            if (frame_C & 0x20) {
                explanations.push('带地址域')
            } else {
                explanations.push('不带地址域')
            }
            explanations.push(((frame_C >> 2) & 0b11).toString(16))
            explanations.push(((frame_C >> 0) & 0b11).toString(16))

            explanations.forEach(explanation => {
                const td = document.createElement('td');
                td.textContent = explanation;
                explanationRow.appendChild(td);
            });
            tbody.appendChild(explanationRow);

            // 将表体添加到表格
            table.appendChild(tbody);

            // 将表格添加到容器中
            resultDiv.appendChild(table);

            // 数据
            element = document.createElement('p');
            element.textContent = '数据：' + hexArray.slice(4, frame_len - 2);
            resultDiv.appendChild(element);

            // 校验
            element = document.createElement('p');
            element.textContent = '校验：' + hexArray[frame_len - 2] + 'H, ' + frame_cs.toString(16).padStart(2, '0').toUpperCase() + 'H';
            resultDiv.appendChild(element);

            // 结束
            element = document.createElement('p');
            element.textContent = '结束：' + hexArray[frame_len - 1] + 'H';
            resultDiv.appendChild(element);
        }
    </script>

    <table>

        长度 L ：是指帧数据的总长度，由 2 字节组成，包括用户数据长度 L1 和 6 个字节的固定
        长度（起始字符、长度、控制域、校验和、结束字符）。<br><br>

        帧校验和 CS ：是控制域和用户数据区所有字节的八位位组算术和，不考虑溢出位。<br><br>


        <tr>
            <td>起始字符（68H）</td>
            <td rowspan="2">固定报文头</td>
        </tr>
        <tr>
            <td>长度L</td>
        </tr>
        <tr>
            <td>控制域C</td>
            <td>控制域</td>
        </tr>
        <tr>
            <td>用户数据</td>
            <td>用户数据区</td>
        </tr>
        <tr>
            <td>校验和 CS</td>
            <td>帧校验和</td>
        </tr>
        <tr>
            <td>结束字符（16H）</td>
            <td>固定报文尾</td>
        </tr>
    </table>
    <p style="text-align: center;">图 1 传输帧格式</p>

</body>

</html>